<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ano-Chat (1.1.3)</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
    background: #ffffff;
    color: #333;
    line-height: 1.5;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 40px 20px;
  }

  header {
    margin-bottom: 40px;
    border-bottom: 1px solid #e0e0e0;
    padding-bottom: 20px;
  }

  header h1 {
    font-size: 2em;
    font-weight: 400;
    letter-spacing: 0.5px;
  }

  header p {
    font-size: 0.9em;
    color: #666;
    margin-top: 8px;
  }

  .main-grid {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 40px;
  }

  @media (max-width: 768px) {
    .main-grid { grid-template-columns: 1fr; }
  }

  .panel {
    border: 1px solid #e0e0e0;
    padding: 20px;
    background: #fafafa;
  }

  .panel-title {
    font-size: 0.9em;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #333;
    margin-bottom: 20px;
    border-bottom: 1px solid #e0e0e0;
    padding-bottom: 10px;
  }

  label {
    display: block;
    margin-top: 16px;
    font-size: 0.85em;
    font-weight: 500;
    color: #333;
  }

  input[type="text"],
  input[type="password"] {
    width: 100%;
    padding: 8px 10px;
    margin-top: 6px;
    border: 1px solid #d0d0d0;
    background: #fff;
    font-size: 0.9em;
    font-family: inherit;
  }

  input[type="text"]:focus,
  input[type="password"]:focus {
    outline: none;
    border: 1px solid #333;
  }

  input[type="checkbox"] {
    margin-right: 8px;
    cursor: pointer;
    width: 16px;
    height: 16px;
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    margin-top: 12px;
    font-size: 0.9em;
    cursor: pointer;
  }

  .button-group {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-top: 16px;
  }

  button {
    padding: 10px 12px;
    border: 1px solid #333;
    background: #fff;
    color: #333;
    font-weight: 500;
    font-size: 0.9em;
    cursor: pointer;
    transition: all 0.15s ease;
    font-family: inherit;
  }

  button:hover:not(:disabled) {
    background: #333;
    color: #fff;
  }

  button:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  #leaveBtn {
    grid-column: 1 / -1;
    margin-top: 8px;
  }

  .info-text {
    margin-top: 16px;
    font-size: 0.8em;
    color: #666;
    line-height: 1.6;
  }

  .version {
    margin-top: 16px;
    padding-top: 12px;
    border-top: 1px solid #e0e0e0;
    font-size: 0.75em;
    color: #999;
  }

  #messages {
    height: 500px;
    overflow-y: auto;
    border: 1px solid #e0e0e0;
    padding: 0;
    background: #fff;
    display: flex;
    flex-direction: column;
    gap: 0;
  }

  #messages::-webkit-scrollbar {
    width: 6px;
  }

  #messages::-webkit-scrollbar-track {
    background: #f5f5f5;
  }

  #messages::-webkit-scrollbar-thumb {
    background: #ccc;
  }

  #messages::-webkit-scrollbar-thumb:hover {
    background: #999;
  }

  .msg {
    padding: 12px 16px;
    border-bottom: 1px solid #f0f0f0;
    border-left: none;
  }

  .msg:last-child {
    border-bottom: none;
  }

  .msg-user {
    font-weight: 600;
    font-size: 0.85em;
    color: #333;
    margin-bottom: 4px;
  }

  .msg-content {
    font-size: 0.9em;
    color: #333;
    word-wrap: break-word;
  }

  .msg-time {
    font-size: 0.75em;
    color: #999;
    margin-top: 4px;
  }

  .meta {
    padding: 10px 16px;
    border-bottom: 1px solid #f0f0f0;
    color: #666;
    font-size: 0.8em;
    background: #fafafa;
  }

  .meta:last-child {
    border-bottom: none;
  }

  .message-input-group {
    display: flex;
    gap: 8px;
    margin-top: 12px;
  }

  #messageIn {
    flex: 1;
    padding: 8px 10px;
    border: 1px solid #d0d0d0;
    background: #fff;
    font-size: 0.9em;
    font-family: inherit;
  }

  #messageIn:focus {
    outline: none;
    border: 1px solid #333;
  }

  .action-buttons {
    display: flex;
    gap: 8px;
  }

  #sendBtn, #saveBtn {
    padding: 8px 12px;
    border: 1px solid #333;
    background: #fff;
    color: #333;
    font-weight: 500;
    font-size: 0.9em;
    cursor: pointer;
    font-family: inherit;
    transition: all 0.15s ease;
  }

  #sendBtn:hover:not(:disabled) {
    background: #333;
    color: #fff;
  }

  #saveBtn:hover:not(:disabled) {
    background: #333;
    color: #fff;
  }

  #sendBtn:disabled, #saveBtn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  .chat-container {
    display: flex;
    flex-direction: column;
  }
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>Ano-Chat</h1>
    <p>End-to-end encrypted ephemeral messaging</p>
  </header>

  <div class="main-grid">
    <div>
      <div class="panel">
        <div class="panel-title">Settings</div>

        <label>WebSocket Server</label>
        <input id="wsUrl" type="text" value="wss://ano-app.onrender.com" />

        <label>Room Code</label>
        <input id="roomCode" type="text" placeholder="16 character code" />

        <label>Username</label>
        <input id="username" type="text" placeholder="Your name" />

        <label class="checkbox-label">
          <input type="checkbox" id="anonMode" />
          Anonymous mode
        </label>

        <label>Encryption Password</label>
        <input id="password" type="password" placeholder="Shared secret" />

        <div class="button-group">
          <button id="createBtn">Create</button>
          <button id="joinBtn">Join</button>
        </div>

        <button id="leaveBtn" disabled>Leave</button>

        <div class="info-text">
          Share the 16-character code and password with others to invite them to your chat.
        </div>

        <div class="version">v1.1.3</div>
      </div>
    </div>

    <div class="chat-container">
      <div class="panel" style="flex: 1; display: flex; flex-direction: column; padding: 0;">
        <div class="panel-title" style="margin: 0; padding: 16px; background: #fafafa; border-bottom: 1px solid #e0e0e0;">Messages</div>
        <div id="messages"></div>
      </div>

      <div style="margin-top: 12px;">
        <div class="message-input-group">
          <input id="messageIn" type="text" placeholder="Type message..." />
          <div class="action-buttons">
            <button id="sendBtn" disabled>Send</button>
            <button id="saveBtn" disabled>Save</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const WS_SERVER_INPUT = document.getElementById('wsUrl');
const CREATE_BTN = document.getElementById('createBtn');
const JOIN_BTN = document.getElementById('joinBtn');
const LEAVE_BTN = document.getElementById('leaveBtn');
const ROOM_INPUT = document.getElementById('roomCode');
const USERNAME_INPUT = document.getElementById('username');
const ANON_CHECK = document.getElementById('anonMode');
const PASSWORD_INPUT = document.getElementById('password');
const MESSAGE_INPUT = document.getElementById('messageIn');
const SEND_BTN = document.getElementById('sendBtn');
const SAVE_BTN = document.getElementById('saveBtn');
const MESSAGES = document.getElementById('messages');

let ws = null;
let currentRoom = null;
let joined = false;
let receivedMessages = [];

CREATE_BTN.disabled = true;
JOIN_BTN.disabled = true;

function genRoomCode() {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  let s = "";
  for (let i=0;i<16;i++) s += chars[Math.floor(Math.random()*chars.length)];
  return s;
}

function addLog(text) {
  const d = document.createElement('div');
  d.className = 'meta';
  d.textContent = text;
  MESSAGES.appendChild(d);
  MESSAGES.scrollTop = MESSAGES.scrollHeight;
}

function appendMessage(displayName, text, meta) {
  const d = document.createElement('div');
  d.className = 'msg';
  d.innerHTML = `<div style="font-weight:600">${displayName || 'Anonymous'}</div>
                 <div>${text}</div>
                 <div class="meta">${meta || ''}</div>`;
  MESSAGES.appendChild(d);
  MESSAGES.scrollTop = MESSAGES.scrollHeight;
}

function abToBase64(buf) {
  let bin = '';
  const bytes = new Uint8Array(buf);
  for (let i=0;i<bytes.byteLength;i++) bin += String.fromCharCode(bytes[i]);
  return btoa(bin);
}
function base64ToAb(b64) {
  const bin = atob(b64);
  const buf = new Uint8Array(bin.length);
  for (let i=0;i<bin.length;i++) buf[i] = bin.charCodeAt(i);
  return buf.buffer;
}

async function roomSalt(room) {
  const data = new TextEncoder().encode(room);
  const h = await crypto.subtle.digest('SHA-256', data);
  return new Uint8Array(h);
}

async function deriveKey(password, room) {
  const pwKey = await crypto.subtle.importKey('raw', new TextEncoder().encode(password), 'PBKDF2', false, ['deriveKey']);
  const salt = await roomSalt(room);
  return crypto.subtle.deriveKey(
    { name: 'PBKDF2', salt, iterations: 150000, hash: 'SHA-256' },
    pwKey,
    { name: 'AES-GCM', length: 256 },
    false,
    ['encrypt','decrypt']
  );
}

async function encryptMessage(plain, password, room) {
  const key = await deriveKey(password, room);
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const ct = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, new TextEncoder().encode(plain));
  return { iv: abToBase64(iv.buffer), ciphertext: abToBase64(ct) };
}

async function decryptMessage(iv_b64, ct_b64, password, room) {
  try {
    const key = await deriveKey(password, room);
    const iv = new Uint8Array(base64ToAb(iv_b64));
    const pt = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, base64ToAb(ct_b64));
    return new TextDecoder().decode(pt);
  } catch {
    return null;
  }
}

function connectWs() {
  if (ws && ws.readyState === WebSocket.OPEN) return;

  const url = WS_SERVER_INPUT.value.trim();
  ws = new WebSocket(url);

  ws.addEventListener('open', () => {
    addLog('Connected to relay server at ' + url);
    CREATE_BTN.disabled = false;
    JOIN_BTN.disabled = false;
  });

  ws.addEventListener('message', async (ev) => {
    let d;
    try { d = JSON.parse(ev.data); } catch { return; }

    if (d.type === 'created') {
      addLog('Room created: ' + d.room);
    } else if (d.type === 'joined') {
      addLog('Joined room: ' + d.room);
    } else if (d.type === 'no-room') {
      addLog('Room does not exist: ' + d.room);
      alert('Room not found.');
      leaveRoomLocal();
    } else if (d.type === 'message') {
      if (d.room !== currentRoom) return;
      const decrypted = await decryptMessage(d.iv, d.ciphertext, PASSWORD_INPUT.value, d.room);
      appendMessage(
        (ANON_CHECK.checked || !d.username) ? null : d.username,
        decrypted === null ? '[decryption failed â€” wrong password?]' : decrypted,
        new Date().toLocaleTimeString()
      );
      receivedMessages.push({
        time: new Date().toISOString(),
        room: d.room,
        username: d.username || null,
        ciphertext: d.ciphertext,
        iv: d.iv,
        plaintextIfDecrypted: decrypted
      });
      SAVE_BTN.disabled = false;
    }
  });

  ws.addEventListener('close', () => {
    addLog('Disconnected from server');
    CREATE_BTN.disabled = true;
    JOIN_BTN.disabled = true;
    setTimeout(connectWs, 500);
  });

  ws.addEventListener('error', () => {});
}

function sendToServer(obj) {
  if (!ws || ws.readyState !== WebSocket.OPEN) return;
  ws.send(JSON.stringify(obj));
}

connectWs();

CREATE_BTN.addEventListener('click', () => {
  const room = genRoomCode();
  ROOM_INPUT.value = room;
  currentRoom = room;
  receivedMessages = [];
  sendToServer({ type: 'create', room });
  joined = true;
  SEND_BTN.disabled = false;
  LEAVE_BTN.disabled = false;
  addLog('Room created, share code & password with peers: ' + room);
});

JOIN_BTN.addEventListener('click', () => {
  const room = ROOM_INPUT.value.trim();
  if (!room || room.length !== 16) return alert('Paste a 16-char room code');
  currentRoom = room;
  receivedMessages = [];
  sendToServer({ type: 'exists', room });
  setTimeout(() => {
    sendToServer({ type: 'join', room });
    joined = true;
    SEND_BTN.disabled = false;
    LEAVE_BTN.disabled = false;
    addLog('Joining room: ' + room);
  }, 200);
});

LEAVE_BTN.addEventListener('click', () => {
  sendToServer({ type: 'leave', room: currentRoom });
  leaveRoomLocal();
  addLog('Left room.');
});

function leaveRoomLocal() {
  currentRoom = null;
  joined = false;
  SEND_BTN.disabled = true;
  LEAVE_BTN.disabled = true;
  MESSAGES.innerHTML = '';
  receivedMessages = [];
  SAVE_BTN.disabled = true;
}

SEND_BTN.addEventListener('click', async () => {
  if (!joined || !currentRoom) return alert('Join or create a room first');
  const text = MESSAGE_INPUT.value.trim();
  if (!text) return;
  const pwd = PASSWORD_INPUT.value;
  const enc = await encryptMessage(text, pwd, currentRoom);
  appendMessage(
    ANON_CHECK.checked ? null : (USERNAME_INPUT.value || 'You'),
    text,
    new Date().toLocaleTimeString() + " (you)"
  );
  receivedMessages.push({
    time: new Date().toISOString(),
    room: currentRoom,
    username: USERNAME_INPUT.value || null,
    ciphertext: enc.ciphertext,
    iv: enc.iv,
    plaintextIfDecrypted: text
  });
  SAVE_BTN.disabled = false;
  sendToServer({
    type: 'message',
    room: currentRoom,
    username: ANON_CHECK.checked ? null : (USERNAME_INPUT.value || 'User'),
    iv: enc.iv,
    ciphertext: enc.ciphertext
  });
  MESSAGE_INPUT.value = '';
});

MESSAGE_INPUT.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    SEND_BTN.click();
  }
});

SAVE_BTN.addEventListener('click', () => {
  const blob = new Blob([JSON.stringify(receivedMessages, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `chat-${currentRoom || 'session'}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});
</script>
</body>
</html>